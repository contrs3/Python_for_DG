from sqlalchemy import create_engine, text
from sqlalchemy.engine.url import  URL
import pandas as pd

def run_query(sql: str, conn=False):
    # connection setup
    if not conn:
        conn_url = URL.create("mssql+pymssql",
                            username='BSCI\\BSCI-SWAUTO-SVC',
                            password='B0ston123',
                            host='132.189.107.223\prod',
                            database='MESMonthly_STP'
                            )
        conn = create_engine(conn_url)
    df = pd.read_sql(sql=sql, con=conn)
    if not conn:
        conn.close()
    return df
containers = ['102066628','102067074','102073129','102078165','102078187','102078223','102121627','102121822','102122861','102122862','102126350','102126529','102126805','102127232',
'102127296','102127528','102130665','102133082','102131143','102133084','102136973','102136976','102171962','102172227','102172624','102172290','102175044','102246609','102248225','102248226',
'102248229','102251770','102252114','102252129','102252158','102252215','102252369','102252925','102253950','102254124','102254449','102269815','102269927','102270343','102275551','102275790','102275936',
'102276479','102276827','102276996','102280741','102280742','102281394','102293825','102294251','102295168','102294390','102295030','102301614','102301615','102301616','102301617','102309610',
'102317706','102317757','102317797','102318171','102325773','102331726','102332593','102332207','102332417','102338640','102332067','102337566','102345878','102346134',
'102337212','102351786','102346476','101724672','101725167','101725405','101725791','101725981','101730079','101726383','101729230']

def connections(batch_list: list):
    query = f'''
    SELECT cs.CONTAINERNAME, cs.MATERIALNAME, cs.FINISHQTY, cs.MFGORDERNAME 
FROM MES.tblContainerStatus cs
WHERE cs.CONTAINERNAME in {tuple(batch_list)}
       '''
    return query

second_string = ''' SELECT cs.CONTAINERNAME, cs.MATERIALNAME, cs.FINISHQTY, cs.MFGORDERNAME 
FROM MES.tblContainerStatus cs
WHERE cs.CONTAINERNAME in ('102066628','102067074','102073129','102078165','102078187','102078223','102121627','102121822','102122861','102122862','102126350','102126529','102126805','102127232',
'102127296','102127528','102130665','102133082','102131143','102133084','102136973','102136976','102171962','102172227','102172624','102172290','102175044','102246609','102248225','102248226',
'102248229','102251770','102252114','102252129','102252158','102252215','102252369','102252925','102253950','102254124','102254449','102269815','102269927','102270343','102275551','102275790','102275936',
'102276479','102276827','102276996','102280741','102280742','102281394','102293825','102294251','102295168','102294390','102295030','102301614','102301615','102301616','102301617','102309610',
'102317706','102317757','102317797','102318171','102325773','102331726','102332593','102332207','102332417','102338640','102332067','102337566','102345878','102346134',
'102337212','102351786','102346476','101724672','101725167','101725405','101725791','101725981','101730079','101726383','101729230')'''
df = run_query(connections(containers))
df2 = run_query(second_string)


csv_path = r'C:\Python\impedance.csv'
df2.to_csv(csv_path, index=False)

print(f"DataFrame saved as CSV at path: {csv_path}")
